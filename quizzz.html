<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í€´ì¦ˆíŒ¡ | MZ ê°ì„± ì‹¤ì‹œê°„ í€´ì¦ˆ</title>
  <meta name="description" content="MZ ê°ì„±ì˜ ë¹ ë¥´ê³  ì§œë¦¿í•œ í•œ ì… í€´ì¦ˆ. ë°ˆ, IT, ìƒì‹, K-ì»¬ì³ê¹Œì§€!" />
  <style>
    :root{
      --bg:#0b0f14;--card:#111827cc;--muted:#94a3b8;--text:#e5e7eb;--brand:#8b5cf6;--brand-2:#22d3ee;--ok:#22c55e;--bad:#ef4444;--shadow:0 10px 30px rgba(0,0,0,.35);
      /* option contrast variables */
      --opt-bg:#0f172a; --opt-border:#334155; --opt-hover:#13223a; --opt-fg:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,\B3CB\C6C0,\D55C\ACA8\B515,\B9D1\C740 \ACE0\B515, Malgun Gothic, Noto Sans KR, Pretendard, sans-serif;
      color:var(--text); background:
        radial-gradient(1200px 600px at 10% -10%, rgba(139,92,246,.25),transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(34,211,238,.25),transparent 60%),
        var(--bg);
    }
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;gap:14px;justify-content:space-between;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand-2));display:grid;place-items:center;box-shadow:var(--shadow)}
    .logo span{font-weight:900;color:#0b0f14}
    h1{font-size:20px;margin:0;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13px}
    .controls{display:flex;align-items:center;gap:10px}
    .btn, button{background:linear-gradient(135deg, var(--brand), var(--brand-2)); color:#0b0f14;border:none;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:var(--shadow)}
    .btn.secondary{background:#1f2937;color:var(--text)}
    .btn.ghost{background:transparent;border:1px solid #243244;color:var(--text)}
    .grid{display:grid;gap:16px}
    .card{background:var(--card);backdrop-filter: blur(10px); border:1px solid #1f2937;border-radius:18px;box-shadow:var(--shadow)}
    .card .inner{padding:18px}

    /* Start section */
    #start{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    @media (max-width: 880px){#start{grid-template-columns:1fr}}
    .hero{padding:28px}
    .hero h2{margin:0 0 6px;font-size:28px}
    .hero p{margin:0;color:var(--muted)}
    .hero .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{font-size:12px;background:#0f172a;border:1px solid #203047;color:#9fb3c8;padding:6px 10px;border-radius:999px}

    .panel label{display:block;color:var(--muted);font-size:13px;margin:6px 0}
    .select, .input{width:100%;background:#0b1220;border:1px solid var(--opt-border);color:var(--text);padding:12px 14px;border-radius:12px}
    .row{display:flex;gap:10px}

    /* Quiz section */
    #quiz{display:none}
    .progress{height:8px;background:#111827;border-radius:999px;overflow:hidden;margin:16px 0}
    .progress .bar{height:100%;width:0;background:linear-gradient(90deg,var(--brand),var(--brand-2))}

    .hud{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .hud .stat{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)}
    .timer{position:relative;width:56px;height:56px;border-radius:50%;display:grid;place-items:center;background:#0b1220;border:1px solid var(--opt-border)}
    .timer svg{position:absolute;inset:0;transform:rotate(-90deg)}
    .timer .ring{stroke:url(#grad);stroke-width:6;fill:none;stroke-dasharray:157;stroke-dashoffset:0;transition:stroke-dashoffset .2s linear}

    .qtext{font-size:22px;line-height:1.4;margin:10px 0 8px;font-weight:800}
    .opts{display:grid;gap:10px}
    .opt{padding:16px;border-radius:14px;border:1px solid var(--opt-border);background:var(--opt-bg);text-align:left;font-weight:700;cursor:pointer;font-size:16px;line-height:1.2;box-shadow:0 2px 0 rgba(0,0,0,.12);color:var(--opt-fg)}
    .opt:hover{background:var(--opt-hover);border-color:var(--opt-border)}
    .opt.correct{border-color:rgba(34,197,94,.9);background:#0f2014;color:#d1fae5}
    .opt.wrong{border-color:rgba(239,68,68,.85);background:#1a0f10;color:#fee2e2}
    .opt:focus-visible{outline:2px solid var(--brand-2); outline-offset:2px}

    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#0b1220;border:1px solid var(--opt-border);color:var(--text);padding:10px 14px;border-radius:12px;display:none}

    /* Result */
    #result{display:none}
    .big{font-size:34px;margin:6px 0}
    .statgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width: 640px){.statgrid{grid-template-columns:1fr 1fr}}
    .pill{padding:10px;border-radius:14px;background:#0b1220;border:1px solid var(--opt-border);text-align:center}
    .share{display:flex;gap:10px;flex-wrap:wrap}

    /* Footer */
    footer{margin:26px 0;color:var(--muted);font-size:12px;text-align:center}
    a.link{color:#a5b4fc;text-decoration:none}

    /* Diagnostics */
    #diagWrap{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:flex-start;justify-content:center;padding:40px;z-index:9999}
    #diag{max-width:820px;width:100%;}
    #diag .inner{max-height:70vh;overflow:auto}
    .ok{color:#22c55e}
    .fail{color:#ef4444}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"><span>âš¡</span></div>
        <div>
          <h1>í€´ì¦ˆíŒ¡</h1>
          <div class="sub">MZ ê°ì„± í•œ ì… í€´ì¦ˆ â€” ë¹ ë¥´ê²Œ í’€ê³ , ì‹ ë‚˜ê²Œ ê³µìœ !</div>
        </div>
      </div>
      <div class="controls">
        <button id="toggleTheme" class="btn ghost" title="ë¼ì´íŠ¸/ë‹¤í¬">ğŸŒ“ í…Œë§ˆ</button>
        <button id="toggleSound" class="btn ghost" title="íš¨ê³¼ìŒ">ğŸ”ˆ ì‚¬ìš´ë“œ</button>
        <button id="howto" class="btn secondary">â“ ì´ìš©ë²•</button>
        <button id="diagBtn" class="btn ghost" title="ì§„ë‹¨/í…ŒìŠ¤íŠ¸">ğŸ§ª ì§„ë‹¨</button>
        <button id="startBtn" class="btn">ğŸš€ ì‹œì‘í•˜ê¸°</button>
      </div>
    </header>

    <!-- Start Screen -->
    <section id="start" class="grid">
      <div class="card hero">
        <div class="inner">
          <h2>ì˜¤ëŠ˜ì˜ ë¸Œë ˆì¸ ìŠ¤íŒŒí¬ âœ¨</h2>
          <p>ìƒì‹, IT, K-ì»¬ì³, ë°ˆê¹Œì§€. 20ì´ˆ ì•ˆì— ì§ê°ìœ¼ë¡œ ì°ì§€ ë§ê³  <b>ê·¼ê±° ê¸°ë°˜</b>ìœ¼ë¡œ ë§ì¶°ë³´ì. (ë¬¼ë¡  ì°ì–´ì„œ ë§ì¶”ë©´ ìš´ë™ìš´ ë§ìŒ ğŸ˜)</p>
          <div class="chips">
            <span class="chip">#ìƒì‹</span>
            <span class="chip">#IT</span>
            <span class="chip">#K-ì»¬ì³</span>
            <span class="chip">#ë°ˆ</span>
            <span class="chip">#ë„Œì„¼ìŠ¤</span>
          </div>
        </div>
      </div>
      <div class="card panel">
        <div class="inner">
          <label>ì¹´í…Œê³ ë¦¬</label>
          <select id="category" class="select">
            <option value="mix">ë¯¹ìŠ¤ (ì¶”ì²œ)</option>
            <option value="common">ìƒì‹</option>
            <option value="it">ITÂ·ê°œë°œ</option>
            <option value="kpop">K-ì»¬ì³</option>
            <option value="meme">ë°ˆ/ì‹ ì¡°ì–´</option>
          </select>

          <label>ë¬¸í•­ ìˆ˜</label>
          <div class="row">
            <input id="count" class="input" type="number" min="5" max="20" step="1" value="10"/>
            <button id="fillSample" class="btn ghost" title="ìƒ˜í”Œ 10ë¬¸ì œ">ğŸ² ìƒ˜í”Œ</button>
          </div>

          <label>ë‚œì´ë„</label>
          <select id="difficulty" class="select">
            <option value="auto">ìë™ (ì‹¤ë ¥ ê¸°ë°˜)</option>
            <option value="easy">ì‰¬ì›€</option>
            <option value="mid">ë³´í†µ</option>
            <option value="hard">ì–´ë ¤ì›€</option>
          </select>

          <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
            <button id="goQuiz" class="btn" style="flex:1">ì‹œì‘!</button>
            <button id="editBtn" class="btn secondary" style="flex:1">ğŸ› ï¸ ë¬¸ì œ í¸ì§‘</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Quiz Screen -->
    <section id="quiz" class="card">
      <div class="inner">
        <div class="hud">
          <div class="stat">ë¬¸í•­ <b id="idx">1</b>/<span id="total">10</span></div>
          <div class="stat">ì—°ì†ì •ë‹µ ğŸ”¥ <b id="streak">0</b></div>
          <div class="stat">ì ìˆ˜ â­ <b id="score">0</b></div>
          <div class="timer" aria-label="ë‚¨ì€ ì‹œê°„">
            <svg viewBox="0 0 56 56">
              <defs>
                <linearGradient id="grad" x1="0" x2="1">
                  <stop offset="0%" stop-color="var(--brand)"/>
                  <stop offset="100%" stop-color="var(--brand-2)"/>
                </linearGradient>
              </defs>
              <circle class="ring" cx="28" cy="28" r="25"/>
            </svg>
            <b id="time">20</b>
          </div>
        </div>

        <div class="progress"><div class="bar" id="bar"></div></div>
        <div class="qtext" id="qtext">ë¬¸ì œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
        <div id="qimgWrap" style="display:none;margin:6px 0 10px"><img id="qimg" alt="ë¬¸ì œ ì´ë¯¸ì§€" style="max-width:100%;border-radius:12px;border:1px solid var(--opt-border)"/></div>
        <div class="opts" id="opts"></div>
      </div>
    </section>

    <!-- Result Screen -->
    <section id="result" class="grid" style="margin-top:16px">
      <div class="card">
        <div class="inner">
          <div style="display:flex;align-items:center;gap:10px;justify-content:space-between">
            <div>
              <div style="opacity:.8">ë‚´ ìµœì¢… ìŠ¤ì½”ì–´</div>
              <div class="big" id="finalScore">0 / 0</div>
              <div id="reaction" style="font-size:22px">ğŸ™‚</div>
            </div>
            <div class="pill">
              ìµœê³ ê¸°ë¡ ğŸ† <b id="best">0</b>
            </div>
          </div>

          <div class="statgrid" style="margin-top:12px">
            <div class="pill">ì •ë‹µë¥  <b id="acc">0%</b></div>
            <div class="pill">ìµœëŒ€ ì—°ì†ì •ë‹µ <b id="bestStreak">0</b></div>
            <div class="pill">ì†Œìš”ì‹œê°„ <b id="spent">0s</b></div>
          </div>

          <div class="share" style="margin-top:14px">
            <button id="retry" class="btn">ë‹¤ì‹œ í’€ê¸° ğŸ”</button>
            <button id="shareBtn" class="btn secondary">ê²°ê³¼ ê³µìœ  ğŸ“¤</button>
            <button id="copyBtn" class="btn ghost">í´ë¦½ë³´ë“œ ë³µì‚¬ ğŸ“‹</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="inner">
          <h3 style="margin:0 0 8px">ë¬¸ì œ ì§ì ‘ ë„£ê¸° (JSON)</h3>
          <p class="sub" style="margin:0 0 8px">í˜•ì‹: <code>[{ q, opts:[...], answer:0, img:null, tag:"common", level:"mid" }]</code></p>
          <textarea id="editor" class="input" rows="10" style="height:220px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="apply" class="btn">ì ìš©í•˜ê¸°</button>
            <button id="download" class="btn secondary">ë¬¸ì œ JSON ë‹¤ìš´ë¡œë“œ</button>
            <button id="import" class="btn ghost">íŒŒì¼ ê°€ì ¸ì˜¤ê¸°</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Diagnostics Modal -->
    <div id="diagWrap">
      <div id="diag" class="card">
        <div class="inner">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
            <h3 style="margin:0">ğŸ§ª ë‚´ë¶€ ì§„ë‹¨ ê²°ê³¼</h3>
            <button id="diagClose" class="btn ghost">ë‹«ê¸°</button>
          </div>
          <ol id="diagList" style="margin-top:12px"></ol>
        </div>
      </div>
    </div>

    <div class="toast" id="toast">ë³µì‚¬ ì™„ë£Œ!</div>

    <footer>
      Â© <span id="year"></span> QUIZPANG. ë°ˆì€ ìˆœê°„, ì‹¤ë ¥ì€ ì˜ì›. (ê·¼ë° ì°ì–´ì„œ ë§ì¶”ë©´ ë‹˜ì´ ì´ê¹€) Â· <a class="link" href="#" id="exportHtml">ì†ŒìŠ¤ ë‚´ë ¤ë°›ê¸°</a>
    </footer>
  </div>

  <audio id="sndOk" preload="auto"><source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA..." type="audio/mp3"></audio>
  <audio id="sndBad" preload="auto"><source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA..." type="audio/mp3"></audio>

  <script>
  // --- ìƒ˜í”Œ ë°ì´í„° -----------------------------------------------------------
  const SAMPLE = [
    {q:"MZê°€ ìì£¼ ì“°ëŠ” 'ê°“ìƒ'ì˜ ì˜ë¯¸ëŠ”?", opts:["ì‹ ì„ ë¯¿ëŠ” ì‚¶","ìê¸°ê´€ë¦¬ ì² ì €í•œ ì‚¶","ê²Œì„ë§Œ í•˜ëŠ” ì‚¶","ì‹ ì˜ ì˜ì—­ì„ ì—°êµ¬"], answer:1, img:null, tag:"meme", level:"easy"},
    {q:"HTTP ìƒíƒœì½”ë“œ 404ëŠ”?", opts:["ê¶Œí•œì—†ìŒ","ì„œë²„ì˜¤ë¥˜","ì°¾ì„ ìˆ˜ ì—†ìŒ","ë¦¬ë‹¤ì´ë ‰íŠ¸"], answer:2, img:null, tag:"it", level:"easy"},
    {q:"ë‹¤ìŒ ì¤‘ K-íŒ ë³´ì´ê·¸ë£¹ì´ ì•„ë‹Œ ê²ƒì€?", opts:["ì„¸ë¸í‹´","DAY6","ITZY","ìŠ¤íŠ¸ë ˆì´ í‚¤ì¦ˆ"], answer:2, img:null, tag:"kpop", level:"mid"},
    {q:"íŒŒì´ì¬ì—ì„œ ë¦¬ìŠ¤íŠ¸ ê¸¸ì´ë¥¼ êµ¬í•˜ëŠ” í•¨ìˆ˜ëŠ”?", opts:["len()","size()","count()","length()"], answer:0, img:null, tag:"it", level:"easy"},
    {q:"ë°ˆ 'ì§¤'ì—ì„œ ìœ ë˜í•œ 'ì§¤'ì˜ ëœ»ì€?", opts:["ì§§ì€ ì´ë¯¸ì§€/ì˜ìƒ","ì˜ìƒê¹€","ì§§ì€ ê¸€","ì§¤ë§‰í•œ ì†Œì„¤"], answer:0, img:null, tag:"meme", level:"easy"},
    {q:"ì§€êµ¬ì˜ ìœ„ì„±ì€?", opts:["ë‹¬","í™”ì„±","ê¸ˆì„±","í† ì„±"], answer:0, img:null, tag:"common", level:"easy"},
    {q:"'TMI'ì˜ ì˜ë¯¸ëŠ”?", opts:["Too Many Ideas","Tell Me Info","Too Much Information","Try Me If"], answer:2, img:null, tag:"meme", level:"easy"},
    {q:"ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ === ëŠ”?", opts:["ëŠìŠ¨í•œ ë™ì¹˜","ì—„ê²©í•œ ë™ì¹˜","ë¹„êµ ë¶ˆê°€","ëŒ€ì… ì—°ì‚°"], answer:1, img:null, tag:"it", level:"mid"},
    {q:"í•œê¸€ì„ ì°½ì œí•œ ì™•ì€?", opts:["ì„¸ì¢…","íƒœì¢…","ì •ì¡°","ê´‘í•´"], answer:0, img:null, tag:"common", level:"easy"},
    {q:"'Flex í•˜ë‹¤'ì˜ ë‰˜ì•™ìŠ¤ëŠ”?", opts:["íƒ„ë ¥ìš´ë™","ê³¼ì‹œí•˜ë‹¤","ìœ ì—°ê·¼ë¬´","ê°€ê²© ì¸í•˜"], answer:1, img:null, tag:"meme", level:"mid"}
  ];

  // --- ìƒíƒœ -----------------------------------------------------------------
  const $ = (s, p=document)=>p.querySelector(s);
  const $$ = (s, p=document)=>[...p.querySelectorAll(s)];
  const state = {
    bank: [...SAMPLE],
    deck: [],
    idx: 0,
    score: 0,
    streak: 0,
    best: +localStorage.getItem('qp_best')||0,
    bestStreak: +localStorage.getItem('qp_bestStreak')||0,
    total: 10,
    seconds: 20,
    timerId: null,
    startedAt: 0,
    spent: 0,
    sound: localStorage.getItem('qp_sound')!=="off",
    theme: localStorage.getItem('qp_theme')||'dark'
  };

  // --- ìœ í‹¸ -----------------------------------------------------------------
  const shuffle = arr => arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(v=>v[1]);
  const toast = (msg)=>{ const t=$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1200)}
  const setRing = (remain)=>{ const max=157; const used = (1-remain/state.seconds)*max; $('.ring').style.strokeDashoffset = Math.min(max, used); }
  const play = (ok)=>{ if(!state.sound) return; const id= ok?'#sndOk':'#sndBad'; try{$(id).currentTime=0; $(id).play()}catch(e){} }
  const seconds = ()=>Math.round((Date.now()-state.startedAt)/1000)

  // --- ì´ˆê¸° ì„¸íŒ… --------------------------------------------------------------
  $('#year').textContent = new Date().getFullYear();
  function applyTheme(mode){
    const r = document.documentElement.style;
    if(mode==='light'){
      r.setProperty('--bg','#f6f7fb');
      r.setProperty('--card','rgba(255,255,255,0.9)');
      r.setProperty('--text','#0b0f14');
      r.setProperty('--muted','#475569');
      /* Light ëª¨ë“œì—ì„œë„ ë³´ê¸° ê¸€ì”¨ëŠ” í°ìƒ‰ìœ¼ë¡œ, ë°°ê²½ì„ ì§„í•˜ê²Œ ì¡°ì • */
      r.setProperty('--opt-bg','#1f2333');
      r.setProperty('--opt-border','#2a3650');
      r.setProperty('--opt-hover','#26324d');
      r.setProperty('--opt-fg','#ffffff');
    } else {
      r.setProperty('--bg','#0b0f14');
      r.setProperty('--card','#111827cc');
      r.setProperty('--text','#e5e7eb');
      r.setProperty('--muted','#94a3b8');
      r.setProperty('--opt-bg','#0f172a');
      r.setProperty('--opt-border','#334155');
      r.setProperty('--opt-hover','#13223a');
      r.setProperty('--opt-fg','#ffffff');
    }
  }
  applyTheme(state.theme);
  $('#toggleSound').textContent = state.sound ? 'ğŸ”Š ì‚¬ìš´ë“œ' : 'ğŸ”ˆ ì‚¬ìš´ë“œ';

  // --- ë¬¸ì œ ì—ë””í„° ------------------------------------------------------------
  const updateEditor = ()=> $('#editor').value = JSON.stringify(state.bank, null, 2);
  updateEditor();

  $('#apply').onclick = ()=>{
    try{
      const data = JSON.parse($('#editor').value);
      if(!Array.isArray(data)) throw new Error('ë°°ì—´ ì•„ë‹˜');
      state.bank = data;
      toast('ë¬¸ì œì„¸íŠ¸ ì ìš© ì™„ë£Œ');
    }catch(e){ toast('JSON í˜•ì‹ ì˜¤ë¥˜ ğŸ˜µ'); }
  }

  $('#download').onclick = ()=>{
    const blob = new Blob([$('#editor').value], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = 'quizpang_questions.json'; a.click();
  }

  $('#import').onclick = ()=>{
    const inp = document.createElement('input'); inp.type='file'; inp.accept='.json,application/json';
    inp.onchange = async ()=>{ const f=inp.files[0]; const t = await f.text(); $('#editor').value=t; toast('ë¡œë“œ ì™„ë£Œ. ì ìš© ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”')}
    inp.click();
  }

  $('#exportHtml').onclick = (e)=>{
    e.preventDefault();
    const src = document.documentElement.outerHTML;
    const blob = new Blob([src], {type:'text/html'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='quizpang.html'; a.click();
  }

  // --- ì‹œì‘ ë¡œì§ --------------------------------------------------------------
  $('#fillSample').onclick = ()=>{ $('#category').value='mix'; $('#difficulty').value='auto'; $('#count').value=10; toast('ìƒ˜í”Œ ì„¸íŒ… ì™„ë£Œ'); }
  $('#startBtn').onclick = ()=> window.scrollTo({top:0,behavior:'smooth'})
  $('#goQuiz').onclick = ()=> startQuiz();
  $('#retry').onclick = ()=> { show('start'); }

  function pickByCategory(cat){
    if(cat==='mix') return [...state.bank]
    return state.bank.filter(q=>q.tag===cat)
  }

  function filterByLevel(list, diff){
    if(diff==='auto') return list; return list.filter(q=>q.level===diff)
  }

  function startQuiz(){
    const cat = $('#category').value; const diff = $('#difficulty').value; const cnt = Math.max(5, Math.min(20, +$('#count').value||10));
    let pool = pickByCategory(cat);
    pool = filterByLevel(pool, diff);
    if(pool.length < cnt){ toast(`í•´ë‹¹ ì˜µì…˜ì— ë¬¸ì œ ${cnt}ê°œ ë¶€ì¡±í•˜ì—¬ ë¯¹ìŠ¤ë¡œ ë³´ì¶©`); pool = pickByCategory('mix') }
    state.deck = shuffle(pool).slice(0, cnt);
    state.idx = 0; state.score = 0; state.streak = 0; state.total = cnt; state.spent=0;
    $('#total').textContent = cnt; $('#streak').textContent=0; $('#score').textContent=0;
    state.startedAt = Date.now();
    show('quiz');
    next();
  }

  function show(which){
    $('#start').style.display = which==='start' ? 'grid':'none';
    $('#quiz').style.display  = which==='quiz'  ? 'block':'none';
    $('#result').style.display= which==='result'? 'grid':'none';
    if(which!=='quiz') stopTimer();
  }

  function next(){
    if(state.idx>=state.total){ return finish(); }
    const q = state.deck[state.idx];
    $('#idx').textContent = state.idx+1;
    $('#qtext').textContent = q.q;
    if(q.img){ $('#qimgWrap').style.display='block'; $('#qimg').src=q.img } else { $('#qimgWrap').style.display='none' }

    const box = $('#opts'); box.innerHTML='';
    q.opts.forEach((t,i)=>{
      const b=document.createElement('button'); b.className='opt'; b.textContent=t;
      b.onclick=()=>select(i);
      box.appendChild(b);
    })

    $('#bar').style.width = `${(state.idx/state.total)*100}%`;

    startTimer();
  }

  function startTimer(){
    let remain = state.seconds; $('#time').textContent=remain; setRing(remain);
    stopTimer();
    state.timerId = setInterval(()=>{
      remain--; $('#time').textContent=remain; setRing(remain);
      if(remain<=0){ stopTimer(); reveal(null) }
    },1000)
  }
  function stopTimer(){ if(state.timerId){ clearInterval(state.timerId); state.timerId=null } }

  function select(i){
    if(state.timerId===null) return; // already answered
    stopTimer(); reveal(i);
  }

  function reveal(choice){
    const q = state.deck[state.idx];
    const buttons = $$('#opts .opt');
    buttons.forEach((b,j)=>{
      b.disabled=true; b.style.cursor='default';
      if(j===q.answer){ b.classList.add('correct') }
      if(choice!==null && j===choice && j!==q.answer){ b.classList.add('wrong') }
    })

    if(choice===q.answer){
      state.score += 10 + Math.min(10, state.streak*2); // ì—°ì† ê°€ì 
      state.streak++; play(true);
    } else {
      state.streak = 0; play(false);
    }
    $('#score').textContent = state.score; $('#streak').textContent = state.streak;

    setTimeout(()=>{ state.idx++; next(); }, 650)
  }

  function finish(){
    state.spent = seconds();
    const acc = Math.round((state.score / (state.total*20)) * 100); // ëŒ€ëµì¹˜ (ì •ë‹µ+ì—°ì† ê°€ì  ê³ ë ¤)

    state.best = Math.max(state.best, state.score);
    state.bestStreak = Math.max(state.bestStreak, state.streak);
    localStorage.setItem('qp_best', state.best);
    localStorage.setItem('qp_bestStreak', state.bestStreak);

    $('#finalScore').textContent = `${state.score} / ${state.total*20}`;
    $('#best').textContent = state.best;
    $('#acc').textContent = isFinite(acc)? acc+"%" : '0%';
    $('#bestStreak').textContent = state.bestStreak;
    $('#spent').textContent = state.spent + 's';
    $('#reaction').textContent = acc>=85? 'ğŸ¤¯ ê°“ìƒëŸ¬ ì¸ì¦' : acc>=60? 'ğŸ˜ ê·¼ë³¸ìˆë„¤' : acc>=40? 'ğŸ™‚ ì›Œë°ì—… ì™„ë£Œ' : 'ğŸ«  ë°ˆ ë” ë³´ê¸° ì¶”ì²œ';

    $('#bar').style.width = '100%';
    show('result');
  }

  // --- ê³µìœ  / ë³µì‚¬ -----------------------------------------------------------
  $('#shareBtn').onclick = async ()=>{
    const msg = makeShareMessage();
    if(navigator.share){
      try{ await navigator.share({title:'í€´ì¦ˆíŒ¡ ê²°ê³¼', text: msg}); }
      catch(e){ toast('ê³µìœ  ì·¨ì†Œ') }
    } else { navigator.clipboard.writeText(msg); toast('í´ë¦½ë³´ë“œ ë³µì‚¬ ì™„ë£Œ') }
  }
  $('#copyBtn').onclick = ()=>{ navigator.clipboard.writeText(makeShareMessage()); toast('ë³µì‚¬ ì™„ë£Œ') }
  function makeShareMessage(){
    const acc = $('#acc').textContent; const sc = $('#finalScore').textContent; const bs = $('#bestStreak').textContent;
    return `í€´ì¦ˆíŒ¡ ê²°ê³¼\nì ìˆ˜: ${sc}\nì •ë‹µë¥ : ${acc}\nìµœëŒ€ ì—°ì†: ${bs}\në„ì „? ğŸ‘‰ https://example.com`;
  }

  // --- í…Œë§ˆ/ì‚¬ìš´ë“œ/í—¬í”„ ------------------------------------------------------
  $('#toggleTheme').onclick = ()=>{
    state.theme = state.theme==='dark' ? 'light' : 'dark';
    localStorage.setItem('qp_theme', state.theme);
    applyTheme(state.theme);
  }
  $('#toggleSound').onclick = ()=>{
    state.sound = !state.sound; localStorage.setItem('qp_sound', state.sound? 'on':'off');
    $('#toggleSound').textContent = state.sound ? 'ğŸ”Š ì‚¬ìš´ë“œ' : 'ğŸ”ˆ ì‚¬ìš´ë“œ';
  }
  $('#howto').onclick = ()=>{
    alert(`ì‚¬ìš©ë²•\n\n1) ì¹´í…Œê³ ë¦¬/ë‚œì´ë„/ë¬¸í•­ìˆ˜ ì„ íƒ í›„ ì‹œì‘\n2) ë¬¸ì œëŠ” 20ì´ˆ ì œí•œ, ì—°ì†ì •ë‹µ ë³´ë„ˆìŠ¤ ìˆìŒ\n3) ê²°ê³¼ëŠ” ê³µìœ  ê°€ëŠ¥ (Web Share/í´ë¦½ë³´ë“œ)\n4) ìš°ì¸¡ì˜ JSON í¸ì§‘ê¸°ì—ì„œ ë¬¸ì œë¥¼ ì§ì ‘ ì¶”ê°€/ìˆ˜ì • ê°€ëŠ¥`)
  }

  // --- ë‚´ë¶€ ì§„ë‹¨(í…ŒìŠ¤íŠ¸) -----------------------------------------------------
  $('#diagBtn').onclick = runDiagnostics;
  $('#diagClose').onclick = ()=>{ document.getElementById('diagWrap').style.display='none' }

  function runDiagnostics(){
    const out = document.getElementById('diagList'); out.innerHTML='';
    const show = (ok,msg)=>{ const li=document.createElement('li'); li.innerHTML = `<b class="${ok?'ok':'fail'}">${ok?'PASS':'FAIL'}</b> â€” ${msg}`; out.appendChild(li) }

    try{
      // T1: í…Œë§ˆ ì ìš© í™•ì¸
      const prev = state.theme; applyTheme('light');
      const bg = getComputedStyle(document.documentElement).getPropertyValue('--bg').trim();
      show(bg==='#f6f7fb','T1 í…Œë§ˆ(light) ë³€ìˆ˜ ì ìš©');
      applyTheme(prev);

      // T2: ì¹´í…Œê³ ë¦¬ í•„í„°
      const itOnly = pickByCategory('it');
      show(itOnly.every(q=>q.tag==='it') && itOnly.length>0, `T2 IT ì¹´í…Œê³ ë¦¬ í•„í„° (${itOnly.length}ë¬¸í•­)`);

      // T3: ë‚œì´ë„ í•„í„°
      const mids = filterByLevel(SAMPLE,'mid');
      show(mids.every(q=>q.level==='mid'), `T3 ë‚œì´ë„(mid) í•„í„° (${mids.length}ë¬¸í•­)`);

      // T4: ì§„í–‰ë°” ê³„ì‚° (ì´ˆê¸° ìƒíƒœ 0%)
      state.idx = 0; state.total = 10; document.getElementById('bar').style.width = `${(state.idx/state.total)*100}%`;
      show(document.getElementById('bar').style.width==='0%', 'T4 ì§„í–‰ë°” ì´ˆê¸° 0%');

      // T5: ë§ íƒ€ì´ë¨¸ dash ê³„ì‚° ì•ˆì „ì„±
      setRing(10); const dash = document.querySelector('.ring').style.strokeDashoffset; show(dash!=='' && !Number.isNaN(parseFloat(dash)), 'T5 ë§ íƒ€ì´ë¨¸ strokeDashoffset ìˆ«ì');

      // T6: ì—ë””í„° JSON ì§ë ¬í™”
      updateEditor(); const parsed = JSON.parse(document.getElementById('editor').value); show(Array.isArray(parsed) && parsed.length===state.bank.length, 'T6 JSON ì—ë””í„° ì§ë ¬/ì—­ì§ë ¬');

      // T7: í…Œë§ˆ í† ê¸€ í•¸ë“¤ëŸ¬ ë¬´ì˜ˆì™¸ ë° ë³€ìˆ˜ ë°˜ì˜
      const before = state.theme; document.getElementById('toggleTheme').click();
      const afterBg = getComputedStyle(document.documentElement).getPropertyValue('--bg').trim();
      show(before!==state.theme && afterBg!==bg, 'T7 í…Œë§ˆ í† ê¸€ ë™ì‘ ë° ë³€ìˆ˜ ë³€ê²½');
      document.getElementById('toggleTheme').click(); // ì›ë³µ

      // T8: ì¹´í…Œê³ ë¦¬ it + cnt=2 ë± ì‚¬ì´ì¦ˆ ê²€ì¦
      document.getElementById('category').value='it'; document.getElementById('count').value=2; document.getElementById('difficulty').value='auto';
      startQuiz();
      show(state.deck.length===2 && state.deck.every(q=>q.tag==='it'), 'T8 startQuiz ë± ì‚¬ì´ì¦ˆ/íƒœê·¸');

      // T9: ì •ë‹µ ì„ íƒ ì‹œ ì ìˆ˜ ì¦ê°€
      state.idx=0; state.total=1; state.deck=[{q:'t',opts:['a','b'],answer:0,tag:'it',level:'easy'}];
      next();
      const scoreBefore=state.score; reveal(0); // ì •ë‹µ
      show(state.score>scoreBefore, 'T9 ì •ë‹µ ì‹œ ì ìˆ˜ ì¦ê°€');

    }catch(e){ show(false, 'ì˜ˆì™¸ ë°œìƒ: '+(e&&e.message? e.message : e)) }

    document.getElementById('diagWrap').style.display='flex';
  }

  </script>
</body>
</html>
