<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>퀴즈팡 | MZ 감성 실시간 퀴즈</title>
  <meta name="description" content="MZ 감성의 빠르고 짜릿한 한 입 퀴즈. 밈, IT, 상식, K-컬쳐까지!" />
  <style>
    :root{
      --bg:#0b0f14;--card:#111827cc;--muted:#94a3b8;--text:#e5e7eb;--brand:#8b5cf6;--brand-2:#22d3ee;--ok:#22c55e;--bad:#ef4444;--shadow:0 10px 30px rgba(0,0,0,.35);
      /* option contrast variables */
      --opt-bg:#0f172a; --opt-border:#334155; --opt-hover:#13223a; --opt-fg:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,\B3CB\C6C0,\D55C\ACA8\B515,\B9D1\C740 \ACE0\B515, Malgun Gothic, Noto Sans KR, Pretendard, sans-serif;
      color:var(--text); background:
        radial-gradient(1200px 600px at 10% -10%, rgba(139,92,246,.25),transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(34,211,238,.25),transparent 60%),
        var(--bg);
    }
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;gap:14px;justify-content:space-between;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand-2));display:grid;place-items:center;box-shadow:var(--shadow)}
    .logo span{font-weight:900;color:#0b0f14}
    h1{font-size:20px;margin:0;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13px}
    .controls{display:flex;align-items:center;gap:10px}
    .btn, button{background:linear-gradient(135deg, var(--brand), var(--brand-2)); color:#0b0f14;border:none;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:var(--shadow)}
    .btn.secondary{background:#1f2937;color:var(--text)}
    .btn.ghost{background:transparent;border:1px solid #243244;color:var(--text)}
    .grid{display:grid;gap:16px}
    .card{background:var(--card);backdrop-filter: blur(10px); border:1px solid #1f2937;border-radius:18px;box-shadow:var(--shadow)}
    .card .inner{padding:18px}

    /* Start section */
    #start{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    @media (max-width: 880px){#start{grid-template-columns:1fr}}
    .hero{padding:28px}
    .hero h2{margin:0 0 6px;font-size:28px}
    .hero p{margin:0;color:var(--muted)}
    .hero .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{font-size:12px;background:#0f172a;border:1px solid #203047;color:#9fb3c8;padding:6px 10px;border-radius:999px}

    .panel label{display:block;color:var(--muted);font-size:13px;margin:6px 0}
    .select, .input{width:100%;background:#0b1220;border:1px solid var(--opt-border);color:var(--text);padding:12px 14px;border-radius:12px}
    .row{display:flex;gap:10px}

    /* Quiz section */
    #quiz{display:none}
    .progress{height:8px;background:#111827;border-radius:999px;overflow:hidden;margin:16px 0}
    .progress .bar{height:100%;width:0;background:linear-gradient(90deg,var(--brand),var(--brand-2))}

    .hud{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .hud .stat{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)}
    .timer{position:relative;width:56px;height:56px;border-radius:50%;display:grid;place-items:center;background:#0b1220;border:1px solid var(--opt-border)}
    .timer svg{position:absolute;inset:0;transform:rotate(-90deg)}
    .timer .ring{stroke:url(#grad);stroke-width:6;fill:none;stroke-dasharray:157;stroke-dashoffset:0;transition:stroke-dashoffset .2s linear}

    .qtext{font-size:22px;line-height:1.4;margin:10px 0 8px;font-weight:800}
    .opts{display:grid;gap:10px}
    .opt{padding:16px;border-radius:14px;border:1px solid var(--opt-border);background:var(--opt-bg);text-align:left;font-weight:700;cursor:pointer;font-size:16px;line-height:1.2;box-shadow:0 2px 0 rgba(0,0,0,.12);color:var(--opt-fg)}
    .opt:hover{background:var(--opt-hover);border-color:var(--opt-border)}
    .opt.correct{border-color:rgba(34,197,94,.9);background:#0f2014;color:#d1fae5}
    .opt.wrong{border-color:rgba(239,68,68,.85);background:#1a0f10;color:#fee2e2}
    .opt:focus-visible{outline:2px solid var(--brand-2); outline-offset:2px}

    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#0b1220;border:1px solid var(--opt-border);color:var(--text);padding:10px 14px;border-radius:12px;display:none}

    /* Result */
    #result{display:none}
    .big{font-size:34px;margin:6px 0}
    .statgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width: 640px){.statgrid{grid-template-columns:1fr 1fr}}
    .pill{padding:10px;border-radius:14px;background:#0b1220;border:1px solid var(--opt-border);text-align:center}
    .share{display:flex;gap:10px;flex-wrap:wrap}

    /* Footer */
    footer{margin:26px 0;color:var(--muted);font-size:12px;text-align:center}
    a.link{color:#a5b4fc;text-decoration:none}

    /* Diagnostics */
    #diagWrap{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:flex-start;justify-content:center;padding:40px;z-index:9999}
    #diag{max-width:820px;width:100%;}
    #diag .inner{max-height:70vh;overflow:auto}
    .ok{color:#22c55e}
    .fail{color:#ef4444}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"><span>⚡</span></div>
        <div>
          <h1>퀴즈팡</h1>
          <div class="sub">MZ 감성 한 입 퀴즈 — 빠르게 풀고, 신나게 공유!</div>
        </div>
      </div>
      <div class="controls">
        <button id="toggleTheme" class="btn ghost" title="라이트/다크">🌓 테마</button>
        <button id="toggleSound" class="btn ghost" title="효과음">🔈 사운드</button>
        <button id="howto" class="btn secondary">❓ 이용법</button>
        <button id="diagBtn" class="btn ghost" title="진단/테스트">🧪 진단</button>
        <button id="startBtn" class="btn">🚀 시작하기</button>
      </div>
    </header>

    <!-- Start Screen -->
    <section id="start" class="grid">
      <div class="card hero">
        <div class="inner">
          <h2>오늘의 브레인 스파크 ✨</h2>
          <p>상식, IT, K-컬쳐, 밈까지. 20초 안에 직감으로 찍지 말고 <b>근거 기반</b>으로 맞춰보자. (물론 찍어서 맞추면 운동운 맞음 😎)</p>
          <div class="chips">
            <span class="chip">#상식</span>
            <span class="chip">#IT</span>
            <span class="chip">#K-컬쳐</span>
            <span class="chip">#밈</span>
            <span class="chip">#넌센스</span>
          </div>
        </div>
      </div>
      <div class="card panel">
        <div class="inner">
          <label>카테고리</label>
          <select id="category" class="select">
            <option value="mix">믹스 (추천)</option>
            <option value="common">상식</option>
            <option value="it">IT·개발</option>
            <option value="kpop">K-컬쳐</option>
            <option value="meme">밈/신조어</option>
          </select>

          <label>문항 수</label>
          <div class="row">
            <input id="count" class="input" type="number" min="5" max="20" step="1" value="10"/>
            <button id="fillSample" class="btn ghost" title="샘플 10문제">🎲 샘플</button>
          </div>

          <label>난이도</label>
          <select id="difficulty" class="select">
            <option value="auto">자동 (실력 기반)</option>
            <option value="easy">쉬움</option>
            <option value="mid">보통</option>
            <option value="hard">어려움</option>
          </select>

          <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
            <button id="goQuiz" class="btn" style="flex:1">시작!</button>
            <button id="editBtn" class="btn secondary" style="flex:1">🛠️ 문제 편집</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Quiz Screen -->
    <section id="quiz" class="card">
      <div class="inner">
        <div class="hud">
          <div class="stat">문항 <b id="idx">1</b>/<span id="total">10</span></div>
          <div class="stat">연속정답 🔥 <b id="streak">0</b></div>
          <div class="stat">점수 ⭐ <b id="score">0</b></div>
          <div class="timer" aria-label="남은 시간">
            <svg viewBox="0 0 56 56">
              <defs>
                <linearGradient id="grad" x1="0" x2="1">
                  <stop offset="0%" stop-color="var(--brand)"/>
                  <stop offset="100%" stop-color="var(--brand-2)"/>
                </linearGradient>
              </defs>
              <circle class="ring" cx="28" cy="28" r="25"/>
            </svg>
            <b id="time">20</b>
          </div>
        </div>

        <div class="progress"><div class="bar" id="bar"></div></div>
        <div class="qtext" id="qtext">문제가 여기에 표시됩니다.</div>
        <div id="qimgWrap" style="display:none;margin:6px 0 10px"><img id="qimg" alt="문제 이미지" style="max-width:100%;border-radius:12px;border:1px solid var(--opt-border)"/></div>
        <div class="opts" id="opts"></div>
      </div>
    </section>

    <!-- Result Screen -->
    <section id="result" class="grid" style="margin-top:16px">
      <div class="card">
        <div class="inner">
          <div style="display:flex;align-items:center;gap:10px;justify-content:space-between">
            <div>
              <div style="opacity:.8">내 최종 스코어</div>
              <div class="big" id="finalScore">0 / 0</div>
              <div id="reaction" style="font-size:22px">🙂</div>
            </div>
            <div class="pill">
              최고기록 🏆 <b id="best">0</b>
            </div>
          </div>

          <div class="statgrid" style="margin-top:12px">
            <div class="pill">정답률 <b id="acc">0%</b></div>
            <div class="pill">최대 연속정답 <b id="bestStreak">0</b></div>
            <div class="pill">소요시간 <b id="spent">0s</b></div>
          </div>

          <div class="share" style="margin-top:14px">
            <button id="retry" class="btn">다시 풀기 🔁</button>
            <button id="shareBtn" class="btn secondary">결과 공유 📤</button>
            <button id="copyBtn" class="btn ghost">클립보드 복사 📋</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="inner">
          <h3 style="margin:0 0 8px">문제 직접 넣기 (JSON)</h3>
          <p class="sub" style="margin:0 0 8px">형식: <code>[{ q, opts:[...], answer:0, img:null, tag:"common", level:"mid" }]</code></p>
          <textarea id="editor" class="input" rows="10" style="height:220px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="apply" class="btn">적용하기</button>
            <button id="download" class="btn secondary">문제 JSON 다운로드</button>
            <button id="import" class="btn ghost">파일 가져오기</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Diagnostics Modal -->
    <div id="diagWrap">
      <div id="diag" class="card">
        <div class="inner">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
            <h3 style="margin:0">🧪 내부 진단 결과</h3>
            <button id="diagClose" class="btn ghost">닫기</button>
          </div>
          <ol id="diagList" style="margin-top:12px"></ol>
        </div>
      </div>
    </div>

    <div class="toast" id="toast">복사 완료!</div>

    <footer>
      © <span id="year"></span> QUIZPANG. 밈은 순간, 실력은 영원. (근데 찍어서 맞추면 님이 이김) · <a class="link" href="#" id="exportHtml">소스 내려받기</a>
    </footer>
  </div>

  <audio id="sndOk" preload="auto"><source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA..." type="audio/mp3"></audio>
  <audio id="sndBad" preload="auto"><source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA..." type="audio/mp3"></audio>

  <script>
  // --- 샘플 데이터 -----------------------------------------------------------
  const SAMPLE = [
    {q:"MZ가 자주 쓰는 '갓생'의 의미는?", opts:["신을 믿는 삶","자기관리 철저한 삶","게임만 하는 삶","신의 영역을 연구"], answer:1, img:null, tag:"meme", level:"easy"},
    {q:"HTTP 상태코드 404는?", opts:["권한없음","서버오류","찾을 수 없음","리다이렉트"], answer:2, img:null, tag:"it", level:"easy"},
    {q:"다음 중 K-팝 보이그룹이 아닌 것은?", opts:["세븐틴","DAY6","ITZY","스트레이 키즈"], answer:2, img:null, tag:"kpop", level:"mid"},
    {q:"파이썬에서 리스트 길이를 구하는 함수는?", opts:["len()","size()","count()","length()"], answer:0, img:null, tag:"it", level:"easy"},
    {q:"밈 '짤'에서 유래한 '짤'의 뜻은?", opts:["짧은 이미지/영상","잘생김","짧은 글","짤막한 소설"], answer:0, img:null, tag:"meme", level:"easy"},
    {q:"지구의 위성은?", opts:["달","화성","금성","토성"], answer:0, img:null, tag:"common", level:"easy"},
    {q:"'TMI'의 의미는?", opts:["Too Many Ideas","Tell Me Info","Too Much Information","Try Me If"], answer:2, img:null, tag:"meme", level:"easy"},
    {q:"자바스크립트에서 === 는?", opts:["느슨한 동치","엄격한 동치","비교 불가","대입 연산"], answer:1, img:null, tag:"it", level:"mid"},
    {q:"한글을 창제한 왕은?", opts:["세종","태종","정조","광해"], answer:0, img:null, tag:"common", level:"easy"},
    {q:"'Flex 하다'의 뉘앙스는?", opts:["탄력운동","과시하다","유연근무","가격 인하"], answer:1, img:null, tag:"meme", level:"mid"}
  ];

  // --- 상태 -----------------------------------------------------------------
  const $ = (s, p=document)=>p.querySelector(s);
  const $$ = (s, p=document)=>[...p.querySelectorAll(s)];
  const state = {
    bank: [...SAMPLE],
    deck: [],
    idx: 0,
    score: 0,
    streak: 0,
    best: +localStorage.getItem('qp_best')||0,
    bestStreak: +localStorage.getItem('qp_bestStreak')||0,
    total: 10,
    seconds: 20,
    timerId: null,
    startedAt: 0,
    spent: 0,
    sound: localStorage.getItem('qp_sound')!=="off",
    theme: localStorage.getItem('qp_theme')||'dark'
  };

  // --- 유틸 -----------------------------------------------------------------
  const shuffle = arr => arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(v=>v[1]);
  const toast = (msg)=>{ const t=$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1200)}
  const setRing = (remain)=>{ const max=157; const used = (1-remain/state.seconds)*max; $('.ring').style.strokeDashoffset = Math.min(max, used); }
  const play = (ok)=>{ if(!state.sound) return; const id= ok?'#sndOk':'#sndBad'; try{$(id).currentTime=0; $(id).play()}catch(e){} }
  const seconds = ()=>Math.round((Date.now()-state.startedAt)/1000)

  // --- 초기 세팅 --------------------------------------------------------------
  $('#year').textContent = new Date().getFullYear();
  function applyTheme(mode){
    const r = document.documentElement.style;
    if(mode==='light'){
      r.setProperty('--bg','#f6f7fb');
      r.setProperty('--card','rgba(255,255,255,0.9)');
      r.setProperty('--text','#0b0f14');
      r.setProperty('--muted','#475569');
      /* Light 모드에서도 보기 글씨는 흰색으로, 배경을 진하게 조정 */
      r.setProperty('--opt-bg','#1f2333');
      r.setProperty('--opt-border','#2a3650');
      r.setProperty('--opt-hover','#26324d');
      r.setProperty('--opt-fg','#ffffff');
    } else {
      r.setProperty('--bg','#0b0f14');
      r.setProperty('--card','#111827cc');
      r.setProperty('--text','#e5e7eb');
      r.setProperty('--muted','#94a3b8');
      r.setProperty('--opt-bg','#0f172a');
      r.setProperty('--opt-border','#334155');
      r.setProperty('--opt-hover','#13223a');
      r.setProperty('--opt-fg','#ffffff');
    }
  }
  applyTheme(state.theme);
  $('#toggleSound').textContent = state.sound ? '🔊 사운드' : '🔈 사운드';

  // --- 문제 에디터 ------------------------------------------------------------
  const updateEditor = ()=> $('#editor').value = JSON.stringify(state.bank, null, 2);
  updateEditor();

  $('#apply').onclick = ()=>{
    try{
      const data = JSON.parse($('#editor').value);
      if(!Array.isArray(data)) throw new Error('배열 아님');
      state.bank = data;
      toast('문제세트 적용 완료');
    }catch(e){ toast('JSON 형식 오류 😵'); }
  }

  $('#download').onclick = ()=>{
    const blob = new Blob([$('#editor').value], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = 'quizpang_questions.json'; a.click();
  }

  $('#import').onclick = ()=>{
    const inp = document.createElement('input'); inp.type='file'; inp.accept='.json,application/json';
    inp.onchange = async ()=>{ const f=inp.files[0]; const t = await f.text(); $('#editor').value=t; toast('로드 완료. 적용 버튼을 눌러주세요')}
    inp.click();
  }

  $('#exportHtml').onclick = (e)=>{
    e.preventDefault();
    const src = document.documentElement.outerHTML;
    const blob = new Blob([src], {type:'text/html'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='quizpang.html'; a.click();
  }

  // --- 시작 로직 --------------------------------------------------------------
  $('#fillSample').onclick = ()=>{ $('#category').value='mix'; $('#difficulty').value='auto'; $('#count').value=10; toast('샘플 세팅 완료'); }
  $('#startBtn').onclick = ()=> window.scrollTo({top:0,behavior:'smooth'})
  $('#goQuiz').onclick = ()=> startQuiz();
  $('#retry').onclick = ()=> { show('start'); }

  function pickByCategory(cat){
    if(cat==='mix') return [...state.bank]
    return state.bank.filter(q=>q.tag===cat)
  }

  function filterByLevel(list, diff){
    if(diff==='auto') return list; return list.filter(q=>q.level===diff)
  }

  function startQuiz(){
    const cat = $('#category').value; const diff = $('#difficulty').value; const cnt = Math.max(5, Math.min(20, +$('#count').value||10));
    let pool = pickByCategory(cat);
    pool = filterByLevel(pool, diff);
    if(pool.length < cnt){ toast(`해당 옵션에 문제 ${cnt}개 부족하여 믹스로 보충`); pool = pickByCategory('mix') }
    state.deck = shuffle(pool).slice(0, cnt);
    state.idx = 0; state.score = 0; state.streak = 0; state.total = cnt; state.spent=0;
    $('#total').textContent = cnt; $('#streak').textContent=0; $('#score').textContent=0;
    state.startedAt = Date.now();
    show('quiz');
    next();
  }

  function show(which){
    $('#start').style.display = which==='start' ? 'grid':'none';
    $('#quiz').style.display  = which==='quiz'  ? 'block':'none';
    $('#result').style.display= which==='result'? 'grid':'none';
    if(which!=='quiz') stopTimer();
  }

  function next(){
    if(state.idx>=state.total){ return finish(); }
    const q = state.deck[state.idx];
    $('#idx').textContent = state.idx+1;
    $('#qtext').textContent = q.q;
    if(q.img){ $('#qimgWrap').style.display='block'; $('#qimg').src=q.img } else { $('#qimgWrap').style.display='none' }

    const box = $('#opts'); box.innerHTML='';
    q.opts.forEach((t,i)=>{
      const b=document.createElement('button'); b.className='opt'; b.textContent=t;
      b.onclick=()=>select(i);
      box.appendChild(b);
    })

    $('#bar').style.width = `${(state.idx/state.total)*100}%`;

    startTimer();
  }

  function startTimer(){
    let remain = state.seconds; $('#time').textContent=remain; setRing(remain);
    stopTimer();
    state.timerId = setInterval(()=>{
      remain--; $('#time').textContent=remain; setRing(remain);
      if(remain<=0){ stopTimer(); reveal(null) }
    },1000)
  }
  function stopTimer(){ if(state.timerId){ clearInterval(state.timerId); state.timerId=null } }

  function select(i){
    if(state.timerId===null) return; // already answered
    stopTimer(); reveal(i);
  }

  function reveal(choice){
    const q = state.deck[state.idx];
    const buttons = $$('#opts .opt');
    buttons.forEach((b,j)=>{
      b.disabled=true; b.style.cursor='default';
      if(j===q.answer){ b.classList.add('correct') }
      if(choice!==null && j===choice && j!==q.answer){ b.classList.add('wrong') }
    })

    if(choice===q.answer){
      state.score += 10 + Math.min(10, state.streak*2); // 연속 가점
      state.streak++; play(true);
    } else {
      state.streak = 0; play(false);
    }
    $('#score').textContent = state.score; $('#streak').textContent = state.streak;

    setTimeout(()=>{ state.idx++; next(); }, 650)
  }

  function finish(){
    state.spent = seconds();
    const acc = Math.round((state.score / (state.total*20)) * 100); // 대략치 (정답+연속 가점 고려)

    state.best = Math.max(state.best, state.score);
    state.bestStreak = Math.max(state.bestStreak, state.streak);
    localStorage.setItem('qp_best', state.best);
    localStorage.setItem('qp_bestStreak', state.bestStreak);

    $('#finalScore').textContent = `${state.score} / ${state.total*20}`;
    $('#best').textContent = state.best;
    $('#acc').textContent = isFinite(acc)? acc+"%" : '0%';
    $('#bestStreak').textContent = state.bestStreak;
    $('#spent').textContent = state.spent + 's';
    $('#reaction').textContent = acc>=85? '🤯 갓생러 인증' : acc>=60? '😎 근본있네' : acc>=40? '🙂 워밍업 완료' : '🫠 밈 더 보기 추천';

    $('#bar').style.width = '100%';
    show('result');
  }

  // --- 공유 / 복사 -----------------------------------------------------------
  $('#shareBtn').onclick = async ()=>{
    const msg = makeShareMessage();
    if(navigator.share){
      try{ await navigator.share({title:'퀴즈팡 결과', text: msg}); }
      catch(e){ toast('공유 취소') }
    } else { navigator.clipboard.writeText(msg); toast('클립보드 복사 완료') }
  }
  $('#copyBtn').onclick = ()=>{ navigator.clipboard.writeText(makeShareMessage()); toast('복사 완료') }
  function makeShareMessage(){
    const acc = $('#acc').textContent; const sc = $('#finalScore').textContent; const bs = $('#bestStreak').textContent;
    return `퀴즈팡 결과\n점수: ${sc}\n정답률: ${acc}\n최대 연속: ${bs}\n도전? 👉 https://example.com`;
  }

  // --- 테마/사운드/헬프 ------------------------------------------------------
  $('#toggleTheme').onclick = ()=>{
    state.theme = state.theme==='dark' ? 'light' : 'dark';
    localStorage.setItem('qp_theme', state.theme);
    applyTheme(state.theme);
  }
  $('#toggleSound').onclick = ()=>{
    state.sound = !state.sound; localStorage.setItem('qp_sound', state.sound? 'on':'off');
    $('#toggleSound').textContent = state.sound ? '🔊 사운드' : '🔈 사운드';
  }
  $('#howto').onclick = ()=>{
    alert(`사용법\n\n1) 카테고리/난이도/문항수 선택 후 시작\n2) 문제는 20초 제한, 연속정답 보너스 있음\n3) 결과는 공유 가능 (Web Share/클립보드)\n4) 우측의 JSON 편집기에서 문제를 직접 추가/수정 가능`)
  }

  // --- 내부 진단(테스트) -----------------------------------------------------
  $('#diagBtn').onclick = runDiagnostics;
  $('#diagClose').onclick = ()=>{ document.getElementById('diagWrap').style.display='none' }

  function runDiagnostics(){
    const out = document.getElementById('diagList'); out.innerHTML='';
    const show = (ok,msg)=>{ const li=document.createElement('li'); li.innerHTML = `<b class="${ok?'ok':'fail'}">${ok?'PASS':'FAIL'}</b> — ${msg}`; out.appendChild(li) }

    try{
      // T1: 테마 적용 확인
      const prev = state.theme; applyTheme('light');
      const bg = getComputedStyle(document.documentElement).getPropertyValue('--bg').trim();
      show(bg==='#f6f7fb','T1 테마(light) 변수 적용');
      applyTheme(prev);

      // T2: 카테고리 필터
      const itOnly = pickByCategory('it');
      show(itOnly.every(q=>q.tag==='it') && itOnly.length>0, `T2 IT 카테고리 필터 (${itOnly.length}문항)`);

      // T3: 난이도 필터
      const mids = filterByLevel(SAMPLE,'mid');
      show(mids.every(q=>q.level==='mid'), `T3 난이도(mid) 필터 (${mids.length}문항)`);

      // T4: 진행바 계산 (초기 상태 0%)
      state.idx = 0; state.total = 10; document.getElementById('bar').style.width = `${(state.idx/state.total)*100}%`;
      show(document.getElementById('bar').style.width==='0%', 'T4 진행바 초기 0%');

      // T5: 링 타이머 dash 계산 안전성
      setRing(10); const dash = document.querySelector('.ring').style.strokeDashoffset; show(dash!=='' && !Number.isNaN(parseFloat(dash)), 'T5 링 타이머 strokeDashoffset 숫자');

      // T6: 에디터 JSON 직렬화
      updateEditor(); const parsed = JSON.parse(document.getElementById('editor').value); show(Array.isArray(parsed) && parsed.length===state.bank.length, 'T6 JSON 에디터 직렬/역직렬');

      // T7: 테마 토글 핸들러 무예외 및 변수 반영
      const before = state.theme; document.getElementById('toggleTheme').click();
      const afterBg = getComputedStyle(document.documentElement).getPropertyValue('--bg').trim();
      show(before!==state.theme && afterBg!==bg, 'T7 테마 토글 동작 및 변수 변경');
      document.getElementById('toggleTheme').click(); // 원복

      // T8: 카테고리 it + cnt=2 덱 사이즈 검증
      document.getElementById('category').value='it'; document.getElementById('count').value=2; document.getElementById('difficulty').value='auto';
      startQuiz();
      show(state.deck.length===2 && state.deck.every(q=>q.tag==='it'), 'T8 startQuiz 덱 사이즈/태그');

      // T9: 정답 선택 시 점수 증가
      state.idx=0; state.total=1; state.deck=[{q:'t',opts:['a','b'],answer:0,tag:'it',level:'easy'}];
      next();
      const scoreBefore=state.score; reveal(0); // 정답
      show(state.score>scoreBefore, 'T9 정답 시 점수 증가');

    }catch(e){ show(false, '예외 발생: '+(e&&e.message? e.message : e)) }

    document.getElementById('diagWrap').style.display='flex';
  }

  </script>
</body>
</html>
